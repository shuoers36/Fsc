package com.hfsc.controller;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.servlet.ModelAndView;
import org.springframework.web.servlet.mvc.AbstractController;
import org.springframework.web.servlet.view.RedirectView;
import org.springframework.web.servlet.view.json.MappingJacksonJsonView;

import com.hfsc.service.impl.MessageServiceImpl;
import com.hfsc.service.impl.MessageServiceImpl;
import com.hfsc.service.impl.MessageServiceImpl;

import net.sf.json.JSONArray;
import net.sf.json.JSONObject;

import com.hfsc.model.Message;
import com.hfsc.service.MessageService;
import com.hfsc.service.MessageService;
import com.hfsc.service.MessageService;
import com.hfsc.model.Message;
import com.hfsc.model.Message;

@Controller
@RequestMapping(value={"message.do"})
public class MessageController extends AbstractController {
	@Override
	  protected ModelAndView handleRequestInternal(HttpServletRequest request,
	      HttpServletResponse response) throws Exception {
		  String message_content  = request.getParameter("message_content");
		  String message_title  = request.getParameter("message_title");
		  String addressee_name = request.getParameter("addressee_name");	
		  String message_id = request.getParameter("message_id");
System.out.println("起始id---"+message_id);
		  String query = request.getParameter("type");
System.out.println("QUERY---"+query);		  
		  query = "ch";   //query=当前登陆账号名
		  String detail_id = request.getParameter("detail_id");
System.out.println("细节---"+detail_id);
		   
		  
		  
		  
		//------------------------删除-----------------------
			if (message_id != "" && message_id != null) {
				ModelAndView mav = new ModelAndView();
				mav.setViewName("message");
System.out.println("进入删除");
				Message message = new Message();
				MessageService messageService = new MessageServiceImpl();
				messageService.deleteMessage((long)Integer.parseInt(message_id));
System.out.println("----------------------");
				return mav;
			}
			
			
			
		//------------------------插入----------------------------
//System.out.println("charu"+addressee_name+"---");
		  if(addressee_name != null) {
			  ModelAndView mav = new ModelAndView();
			  mav.setViewName("message");
System.out.println("进入插入");
			  Message message = new Message();
			  message.setAddressee_name(addressee_name);
			  message.setMessage_title(message_title);
			  message.setMessage_content(message_content);
			  MessageService messageService = new MessageServiceImpl();
			  messageService.sendMessage(message);
System.out.println("----------------------");
			  return mav;
			  
		  }
		  
		
		  
		  
		  //---------------------展示---------------------------------		  
		  if ("ch".equals(query) && detail_id == null) {
			  ModelAndView mav = new ModelAndView();
			  mav.setViewName("message");
System.out.println("进入展示");
				Message message = new Message();					
				List<Message> nlist = new ArrayList<Message>();
				MessageService messageService = new MessageServiceImpl();
				nlist = messageService.queryMessage(query);	
				JSONArray nulist = JSONArray.fromObject(nlist);  
				mav.addObject("nulist",nulist );
//System.out.println("展示---"+message_query);
System.out.println("----------------------");
				return mav;
			}

		  
		  
//System.out.println("细节外");
		  //---------------------展示细节---------------------------------
		  if (detail_id != "" && detail_id != null) {
			  ModelAndView mav1 = new ModelAndView();
			  mav1.setViewName("messageDetil"); 
System.out.println("进入细节");
				Message message = new Message();					
				List<Message> nlist = new ArrayList<Message>();
				MessageService messageService = new MessageServiceImpl();
				nlist = messageService.showDetil((long)Integer.parseInt(detail_id));	
				JSONArray nwlist = JSONArray.fromObject(nlist); 
				mav1.addObject("nwlist",nwlist );
				
System.out.println("----------------------");
				return mav1;
				 
			}
			
		  
		  
		  return null;
	}

}


